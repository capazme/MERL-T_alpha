# ===========================================
# Neo4j Docker Compose Configuration
# ===========================================
#
# Standalone Neo4j configuration for MERL-T Knowledge Graph
# Can be used independently or integrated with main docker-compose.yml
#
# Usage:
#   docker-compose -f infrastructure/docker/neo4j.yml up -d
#
# Access:
#   Browser: http://localhost:7474
#   Bolt: bolt://localhost:7687
#   Credentials: neo4j / merl_t_password
#
# ===========================================

version: '3.8'

services:
  neo4j:
    image: neo4j:5.13-community
    container_name: merl-t-neo4j
    hostname: neo4j

    ports:
      - "7474:7474"  # HTTP Browser interface
      - "7473:7473"  # HTTPS (if enabled)
      - "7687:7687"  # Bolt protocol (main query interface)

    volumes:
      # Persistent data storage
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins

      # Schema initialization script
      - ./init-schema.cypher:/var/lib/neo4j/import/init-schema.cypher:ro

    environment:
      # Authentication
      - NEO4J_AUTH=neo4j/merl_t_password

      # Plugins (APOC for advanced procedures)
      - NEO4J_PLUGINS=["apoc"]

      # Memory settings (adjust based on available RAM)
      # For 5,000+ articles, 2-4GB recommended
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_server_memory_pagecache_size=1G

      # Database settings
      - NEO4J_server_default__database=merl-t-kg

      # Query settings
      - NEO4J_db_query__cache__size=100M
      - NEO4J_dbms_transaction_timeout=60s

      # Bolt connector settings
      - NEO4J_server_bolt_listen__address=0.0.0.0:7687
      - NEO4J_server_bolt_advertised__address=localhost:7687

      # HTTP connector settings
      - NEO4J_server_http_listen__address=0.0.0.0:7474
      - NEO4J_server_http_advertised__address=localhost:7474

      # APOC configuration
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true

      # Logging
      - NEO4J_server_logs_debug_level=INFO

    command: neo4j

    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p merl_t_password 'RETURN 1;' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    restart: unless-stopped

    networks:
      - merl-t-network

    # Resource limits (adjust based on infrastructure)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

volumes:
  neo4j_data:
    name: merl-t-neo4j-data
    driver: local

  neo4j_logs:
    name: merl-t-neo4j-logs
    driver: local

  neo4j_import:
    name: merl-t-neo4j-import
    driver: local

  neo4j_plugins:
    name: merl-t-neo4j-plugins
    driver: local

networks:
  merl-t-network:
    name: merl-t-network
    driver: bridge

# ===========================================
# Post-Startup Setup
# ===========================================
#
# After starting Neo4j, initialize schema:
#
# 1. Access Neo4j Browser:
#    Open http://localhost:7474
#    Login: neo4j / merl_t_password
#
# 2. Create MERL-T database (if not using default):
#    CREATE DATABASE `merl-t-kg`;
#    :use merl-t-kg;
#
# 3. Load schema from file:
#    Method A - Via Browser:
#      Copy contents of init-schema.cypher
#      Paste into Neo4j Browser and execute
#
#    Method B - Via cypher-shell:
#      docker exec -it merl-t-neo4j cypher-shell -u neo4j -p merl_t_password
#      :use merl-t-kg;
#      :source /var/lib/neo4j/import/init-schema.cypher;
#
#    Method C - Via script:
#      cat infrastructure/docker/init-schema.cypher | \
#        docker exec -i merl-t-neo4j cypher-shell \
#        -u neo4j -p merl_t_password \
#        --database merl-t-kg
#
# 4. Verify installation:
#    SHOW CONSTRAINTS;
#    SHOW INDEXES;
#    MATCH (n) RETURN labels(n) AS type, count(*) AS count;
#
# 5. Test sample data:
#    MATCH (a:Articolo {id: "cc_art_1321"}) RETURN a;
#
# ===========================================
# Performance Tuning Notes
# ===========================================
#
# For production with 5,000+ articles:
#
# 1. Increase heap memory:
#    NEO4J_server_memory_heap_max__size=4G
#
# 2. Increase page cache:
#    NEO4J_server_memory_pagecache_size=2G
#
# 3. Enable query logging for optimization:
#    NEO4J_dbms_logs_query_enabled=true
#    NEO4J_dbms_logs_query_threshold=1s
#
# 4. For large imports, increase transaction memory:
#    NEO4J_dbms_memory_transaction_total_max=2G
#
# 5. Enable parallel runtime for complex queries:
#    CYPHER runtime=parallel
#
# ===========================================
# APOC Procedures Available
# ===========================================
#
# Useful APOC procedures for MERL-T:
#
# - apoc.periodic.iterate() - Batch processing
# - apoc.load.json() - Load JSON data
# - apoc.export.* - Export data
# - apoc.cypher.run() - Dynamic Cypher
# - apoc.path.* - Path finding algorithms
#
# Example batch insert:
#   CALL apoc.periodic.iterate(
#     "UNWIND $articles AS article RETURN article",
#     "CREATE (a:Articolo {id: article.id, ...})",
#     {batchSize: 1000, parallel: true, params: {articles: $data}}
#   )
#
# ===========================================
# Backup & Restore
# ===========================================
#
# Backup (using neo4j-admin):
#   docker exec merl-t-neo4j neo4j-admin database dump \
#     merl-t-kg --to-path=/backups/
#   docker cp merl-t-neo4j:/backups ./backups/
#
# Restore:
#   docker cp ./backups/merl-t-kg.dump merl-t-neo4j:/backups/
#   docker exec merl-t-neo4j neo4j-admin database load \
#     merl-t-kg --from-path=/backups/ --overwrite-destination=true
#   docker restart merl-t-neo4j
#
# Alternative - Using APOC:
#   CALL apoc.export.cypher.all("/backups/backup.cypher", {})
#   CALL apoc.cypher.runFile("/backups/backup.cypher")
#
# ===========================================
# Troubleshooting
# ===========================================
#
# Issue: Connection refused
# Solution: Check if port 7687 is already in use
#   lsof -i :7687
#   docker logs merl-t-neo4j
#
# Issue: Out of memory
# Solution: Increase heap size or system RAM
#   Check: docker logs merl-t-neo4j | grep -i memory
#
# Issue: Schema not loading
# Solution: Check file permissions and path
#   docker exec merl-t-neo4j ls -la /var/lib/neo4j/import/
#   chmod 644 infrastructure/docker/init-schema.cypher
#
# Issue: APOC procedures not available
# Solution: Verify APOC plugin installed
#   docker exec merl-t-neo4j ls /plugins/
#   Should see: apoc-5.13.0-core.jar
#
# Issue: Slow queries
# Solution: Check and create indexes
#   SHOW INDEXES;
#   PROFILE your_query;  # Shows execution plan
#   EXPLAIN your_query;  # Shows query plan without executing
#
# Issue: Transaction timeout
# Solution: Increase timeout for long-running imports
#   NEO4J_dbms_transaction_timeout=300s
#
# ===========================================
# Monitoring & Metrics
# ===========================================
#
# View active transactions:
#   SHOW TRANSACTIONS;
#
# View database info:
#   CALL dbms.components();
#   CALL apoc.monitor.kernel();
#   CALL apoc.monitor.store();
#
# Query performance:
#   CALL dbms.listQueries();
#
# ===========================================
